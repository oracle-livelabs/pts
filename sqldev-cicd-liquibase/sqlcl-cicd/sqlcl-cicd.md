# Capture changes with SQLcl Liquibase

## Introduction

In SQLcl, you can now execute commands to generate a changelog for a full schema (changeset and changelogs) or for a single object. Liquibase uses the `DATABASECHANGELOG` table to track the changesets that have been run. The `DATABASECHANGELOGLOCK` table ensures that only one instance of Liquibase is running at a time. The `DATABASECHANGELOG_EXPORT` table tracks the object state and the SQL statements executed during deployment.

Compared to the other scenario that was running Liquibase commands from SQL Developer, the advantages of using Liquibase through SQLcl is the capacity to capture code objects, like functions, packages, procedures, and triggers. Developer just has to switch between SQL Developer IDE and SQLcl command line, while working on the requests/tickets received from project manager (logging system).

Estimated Time: 120 minutes

### Objectives
In this lab, you will:
* Generate and execute schema changesets with object dependencies;
* Generate and execute single object changelogs;
* Generate and execute code changelogs for functions, packages, procedures, and triggers;
* Automatically sort a changeset during creation based on object dependencies;
* Record all SQL statements for changeset or changelog execution.

### Prerequisites
* Capture Oracle Database Changes Introduction;
* You must have SQLcl 19.2 or later installed.


## Task 1: Download SQLcl

1. On Oracle Cloud Developer Image you used for the compute node there is SQLcl installed in folder `/opt/oracle/sqlcl`, however it is necessary to update to version 19.2 or superior. Download the latest version from [SQLcl Downloads](https://www.oracle.com/tools/downloads/sqlcl-downloads.html).

2. Unzip the downloaded package into the existing folder. Replace **[latest-version]** with the actual SQLcl version number.

    ````sh
    <copy>
    ls ~/Downloads/
    sudo unzip ~/Downloads/sqlcl-latest.zip -d /opt/oracle/
    ln -s /opt/oracle/sqlcl/bin/sql /home/oracle/.local/bin/sql
    </copy>
    ````

3. Execute SQLcl.

    ````sh
    <copy>
    sql /nolog
    </copy>
    ````

4. Set the location of your wallet file for your **Dev01** ATP service.

    ````sh
    <copy>
    set cloudconfig /home/oracle/Downloads/Wallet_[Your Initials]Dev01.zip
    </copy>
    ````

5. Connect to your ATP service as **HR** user.

    ````sh
    <copy>
    conn hr/DBlearnPTS#21_@[lowercase-initials]dev01_tp
    </copy>
    ````

6. Verify **HR** user tables.

    ````sql
    <copy>
    tables
    </copy>
    ````

7. You can invoke the Liquibase commands in SQLcl with `liquibase` or `lb`. Verify Liquibase version.

    ````sh
    <copy>
    lb version
    </copy>
    ````

8. To display a list of all available commands, execute `liquibase` or `lb` with no arguments.  

    ````sh
    <copy>
    lb
    </copy>
    ````

9. Exit SQLcl.  

    ````sh
    <copy>
    exit
    </copy>
    ````


## Task 2: Capture initial schema and code

1. Create a new folder for database changes in your project main folder, for the first version of your project.

    > **Note** : Creating a separate folder for your versions and subversions is optional. It may be useful to keep individual changelogs for all objects you change and capture in each one of the versions and subversions. At the same time, you will have to create a new folder. If you have yearly major releases (v.21) and monthly subversions (v.21.4), every month you will create a new subfolder in your project main folder.

    > You can rely on your Git repository to manage your releases (versions and subversions), and save all changelog files in your project main folder. Once an object is modified, and changes are captured, the chagelog in the project main folder is overwritten.

    ````sh
    <copy>
    cd ~/cicd-ws-rep00
    mkdir v1.0
    cd v1.0
    </copy>
    ````

2. This is **Developer #1** from your team, that is capturing the current **HR** schema, connected as **HR** user to the ATP service.

    ````sh
    <copy>
    sql /nolog
    </copy>
    ````

    ````sh
    <copy>
    set cloudconfig /home/oracle/Downloads/Wallet_[Your Initials]Dev01.zip
    </copy>
    ````

    ````sh
    <copy>
    conn hr/DBlearnPTS#21_@[lowercase-initials]dev01_tp
    </copy>
    ````

    ````sh
    <copy>
    lb genschema
    </copy>
    ````

3. To avoid closing and opening your SQLcl connection to the ATP service, open another Terminal tab, and use it for bash commands.

    ````sh
    <copy>
    cd ~/cicd-ws-rep00
    </copy>
    ````

4. Review initial changelog generated by Liquibase.

    ````sh
    <copy>
    gedit v1.0/controller.xml
    </copy>
    ````

5. Run the following bash commands to set the relative path in initial changelog file.

    ````sh
    <copy>
    sed -i -e 's/file="/file=".\//g' v1.0/controller.xml
    sed -i -e 's/\/>/ relativeToChangelogFile="true"\/>/g' v1.0/controller.xml
    </copy>
    ````

6. In `cicd-ws-rep00` folder, create a Liquibase master changelog to reference other changelogs in your project. The master changelog is used to break up your entire changelog into more manageable pieces, by creating multiple changelogs to separate your changesets in a way that makes sense for your project.

    ````sh
    <copy>
    gedit hr-master.xml
    </copy>
    ````

7. Add the following contents to the master changelog, save it, and close:

    ````xml
    <copy>
    <?xml version="1.1" encoding="UTF-8"?>
    <databaseChangeLog
      xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                          http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">
      <include file="./v1.0/controller.xml" relativeToChangelogFile="true"/>
      <changeSet  author="Developer1"  id="tagDatabase-v1">  
        <tagDatabase  tag="version_1.0"/>  
      </changeSet>
    </databaseChangeLog>
    </copy>
    ````

8. From SQLcl, validate your master changelog. Remember you are now in sub-folder `v1.0`.

    ````sh
    <copy>
    lb validate -changelog ./../hr-master.xml
    </copy>

    No issues were found in file ./../hr-master.xml, validation passed.
    ````

9. Mark all these initial changes as deployed in the local development database, as they belong to the initial HR schema we used for our project.

    ````sh
    <copy>
    lb changelogsync -changelog ./../hr-master.xml
    </copy>

    ...
    Operation completed successfully.
    ````

10. Copy and paste into SQL Developer **HR** user connection the generated script from the previous step, run it, and commit changes.

    ````sh
    <copy>
    /* changelogsync script here */

    commit;
    </copy>
    ````

11. Run this query ![](./images/run-query.jpg "") in SQL Developer to see changes currently recorded by Liquibase. `DATABASECHANGELOG` table tracks which changesets have been run in your database schema.

    ````sql
    <copy>
    select ID, AUTHOR, FILENAME, orderexecuted ORD, DESCRIPTION, TAG, EXECTYPE
      from DATABASECHANGELOG order by 4 desc;
    </copy>
    ````

12. Add initial schema changes to the Git repository. Use the second Terminal window tab to run these bash commands in `cicd-ws-rep00` folder.

    ````sh
    <copy>
    export PATH=$PATH:/usr/local/git/bin
    git add v1.0/*
    git add hr-master.xml
    git commit -a -m "Version 1: Add initial HR schema changelog including code"
    git push
    </copy>
    ````

13. Use your token to authenticate to GitHub.

    ````sh
    <copy>
    Username: your_username
    Password: your_token
    </copy>
    ````


## Task 3: Create new database objects and stored code

1. This is **Developer #2** from your team, that clones this Git repository on a local development environment, working on the same project. For this lab, we will not clone the repository with `git clone cicd-ws-rep00`, but will work on the same folder, just to simplify the scenario, and avoid to create multiple copies of these files on the same compute node, as we have a single development environment.

2. Using SQL Developer connection to HR schema, as **Developer #2**, we create a new table. Copy, paste and click Run Statement ![](./images/run-query.jpg "").

    ````sql
    <copy>
    create table PROSPECTS as
    (select EMPLOYEE_ID as PERSON_ID, FIRST_NAME, LAST_NAME, lower(EMAIL) || '@example.com' as EMAIL,
            PHONE_NUMBER, add_months(HIRE_DATE,-120) as BIRTH_DATE, SALARY * 10 as SAVINGS from HR.EMPLOYEES);
    </copy>
    ````

3. Create a new package. Copy, paste and click Run Script ![](./images/run-script.jpg "").

    ````sql
    <copy>
    CREATE OR REPLACE PACKAGE investment_check AS
        TYPE check_record IS RECORD(
           id PROSPECTS.PERSON_ID%TYPE,
           first_name PROSPECTS.FIRST_NAME%TYPE,
           last_name PROSPECTS.LAST_NAME%TYPE,
           investment_limit NUMBER);
        TYPE check_table IS TABLE OF check_record;
        FUNCTION get_limits(check_limit NUMBER)
            RETURN check_table
            PIPELINED;
    END;
    /
    CREATE OR REPLACE PACKAGE BODY investment_check AS
        FUNCTION get_limits(check_limit number)
            RETURN check_table
            PIPELINED IS
            l_rec check_record;
        BEGIN
            FOR l_rec IN (
              select PERSON_ID, FIRST_NAME, LAST_NAME, 3*SAVINGS as INVESTMENT_LIMIT
              from PROSPECTS
              where 3*SAVINGS >= check_limit)
            LOOP
              PIPE ROW (l_rec);
            END LOOP;
            RETURN;
        END get_limits;
    END;
    /
    </copy>
    ````

4. Verify your new package function. Click Run Statement ![](./images/run-query.jpg "").

    ````sql
    <copy>
    SELECT * FROM table(investment_check.get_limits(350000));
    </copy>
    ````

5. Exit SQLcl connection in the Terminal window first tab, and go to your project main folder.

    ````sh
    <copy>
    exit

    cd ~/cicd-ws-rep00
    </copy>
    ````

6. Create a new folder in your project main folder, for the second version of your project.

    ````sh
    <copy>
    mkdir v2.0

    cd v2.0
    </copy>
    ````

7. Connect as **HR** user to the ATP service.

    ````sh
    <copy>
    sql /nolog

    set cloudconfig /home/oracle/Downloads/Wallet_[Your Initials]Dev01.zip

    conn hr/DBlearnPTS#21_@[lowercase-initials]dev01_tp
    </copy>
    ````

8. Use SQLcl connection in the Terminal window first tab to generate changelogs for each one of the new objects individually (run these commands one by one).

    ````sh
    <copy>
    lb genobject -type table -name PROSPECTS

    lb genobject -type PACKAGE_SPEC -name investment_check

    lb genobject -type PACKAGE_BODY -name investment_check
    </copy>
    ````

9. Update master changelog `hr-master.xml` to include the latest objects and code, specifying this is the second version of the project.

    ````xml
    <copy>
    <?xml version="1.1" encoding="UTF-8"?>
    <databaseChangeLog
      xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                          http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">
      <include file="./v1.0/controller.xml" relativeToChangelogFile="true"/>
      <changeSet  author="Developer1"  id="tagDatabase-v1">  
        <tagDatabase  tag="version_1.0"/>  
      </changeSet>
      <include file="./v2.0/prospects_table.xml" relativeToChangelogFile="true"/>
      <include file="./v2.0/investment_check_package_spec.xml" relativeToChangelogFile="true"/>
      <include file="./v2.0/investment_check_package_body.xml" relativeToChangelogFile="true"/>
      <changeSet  author="Developer2"  id="tagDatabase-v2">  
        <tagDatabase  tag="version_2.0"/>  
      </changeSet>
    </databaseChangeLog>
    </copy>
    ````

10. Every time you modify your master changelog, you must validate it.

    ````sh
    <copy>
    lb validate -changelog ./../hr-master.xml
    </copy>

    No issues were found in file ./../hr-master.xml, validation passed.
    ````

11. Mark all these initial changes as deployed in the local development database.

    ````sh
    <copy>
    lb changelogsync -changelog ./../hr-master.xml
    </copy>

    Operation completed successfully.
    ````

12. Use SQL Developer, connected as **HR** user to your ATP service to run the generated script from the previous step, and commit changes.

    ````sql
    <copy>
    /* changelogsync script here */

    commit;
    </copy>
    ````

13. Run this query ![](./images/run-query.jpg "") in SQL Developer to see changes currently recorded by Liquibase. `DATABASECHANGELOG` table tracks which changesets have been run in your database schema.

    ````sql
    <copy>
    select ID, AUTHOR, FILENAME, orderexecuted ORD, DESCRIPTION, TAG, EXECTYPE
      from DATABASECHANGELOG order by 4 desc;
    </copy>
    ````

14. Add initial schema changes to the Git repository. Use the second Terminal window tab to run these bash commands.

    ````sh
    <copy>
    cd ~/cicd-ws-rep00
    git add v2.0/*
    git commit -a -m "Version 2: Prospects table and Investment package"
    git push
    </copy>
    ````


## Task 4: Modify objects, add code, and re-capture changes

1. Now comes **Developer #3** from your team, that clones this Git repository on a local development environment, working on the same project. For this lab, we will not clone the repository with `git clone cicd-ws-rep00`, but will work on the same folder, just to simplify the scenario, and avoid to create multiple copies of these files on the same compute node, as we have a single development environment.

2. **Developer #3** creates new objects in this database development environment. Paste these lines in SQL Developer connected as **HR** user, and click Run Script ![](./images/run-script.jpg "").

    ````sql
    <copy>
    CREATE SEQUENCE "HR_EVENTS_SEQ" MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER NOCYCLE  NOKEEP NOSCALE GLOBAL;
    /
    CREATE TABLE  "HR_EVENTS"
       (	"ID" NUMBER,
            "EVENT_ID" NUMBER,
    	"REGION" VARCHAR2(10),
    	"COUNTRY" VARCHAR2(255),
    	"EVENT_DATE" DATE,
    	"EVENT_NAME" VARCHAR2(255),
    	 CONSTRAINT "HR_EVENTS_PK" PRIMARY KEY ("ID")
      USING INDEX ENABLE
       );
    /
    CREATE OR REPLACE EDITIONABLE TRIGGER  "BI_HR_EVENTS"
      before insert on "HR_EVENTS"              
      for each row
    begin  
      if :new."ID" is null then
        select "HR_EVENTS_SEQ".nextval into :new."ID" from sys.dual;
      end if;
    end;
    /
    </copy>
    ````

3. **Developer #3** also modifies some objects in this database development environment. Paste these lines in SQL Developer and click Run Script ![](./images/run-script.jpg "").

    ````sql
    </copy>
    ALTER TRIGGER  "BI_HR_EVENTS" ENABLE;

    ALTER TABLE prospects ADD experience NUMBER;

    ALTER TABLE employees ADD comments CLOB;
    </copy>
    ````

4. Exit SQLcl connection in the Terminal window first tab, and go to your project main folder.

    ````sh
    <copy>
    exit

    cd ~/cicd-ws-rep00
    </copy>
    ````

5. Create a new folder in your project main folder, for the third version of your project.

    ````sh
    <copy>
    mkdir v3.0

    cd v3.0
    </copy>
    ````

6. Connect as **HR** user to the ATP service.

    ````sh
    <copy>
    sql /nolog

    set cloudconfig /home/oracle/Downloads/Wallet_[Your Initials]Dev01.zip

    conn hr/DBlearnPTS#21_@[lowercase-initials]dev01_tp
    </copy>
    ````

7. Use SQLcl connection in the Terminal window first tab to generate changelogs for each one of the new objects individually (run these commands one by one).

    ````sh
    <copy>
    lb genobject -type SEQUENCE -name HR_EVENTS_SEQ

    lb genobject -type table -name HR_EVENTS

    lb genobject -type TRIGGER -name BI_HR_EVENTS

    lb genobject -type table -name prospects

    lb genobject -type table -name employees
    </copy>
    ````

8. Update master changelog `hr-master.xml` to include the version 3.0 objects and code, specifying this is the third version of the project. Add these lines after the last `</changeSet>` line, leaving the last line unchanged.

    ````xml
    ...
    <copy>
      <include file="./v3.0/hr_events_seq_sequence.xml" relativeToChangelogFile="true"/>
      <include file="./v3.0/hr_events_table.xml" relativeToChangelogFile="true"/>
      <include file="./v3.0/bi_hr_events_trigger.xml" relativeToChangelogFile="true"/>
      <include file="./v3.0/prospects_table.xml" relativeToChangelogFile="true"/>
      <include file="./v3.0/employees_table.xml" relativeToChangelogFile="true"/>
      <changeSet  author="Developer3"  id="tagDatabase-v3">  
        <tagDatabase  tag="version_3.0"/>  
      </changeSet>
    </databaseChangeLog>
    </copy>
    ````

9. Every time you modify your master changelog, you must validate it.

    ````sh
    <copy>
    lb validate -changelog ./../hr-master.xml
    </copy>

    No issues were found in file ./../hr-master.xml, validation passed.
    ````

10. Mark all these initial changes as deployed in the local development database.

    ````sh
    <copy>
    lb changelogsync -changelog ./../hr-master.xml
    </copy>

    Operation completed successfully.
    ````

11. Use SQL Developer, connected as **HR** user to your ATP service to run the generated script from the previous step, and commit changes.

    ````sql
    <copy>
    /* changelogsync script here */

    commit;
    </copy>
    ````

12. Run this query ![](./images/run-query.jpg "") in SQL Developer to see changes currently recorded by Liquibase. `DATABASECHANGELOG` table tracks which changesets have been run in your database schema.

    ````sql
    <copy>
    select ID, AUTHOR, FILENAME, orderexecuted ORD, DESCRIPTION, TAG, EXECTYPE
      from DATABASECHANGELOG order by 4 desc;
    </copy>
    ````

13. Add initial schema changes to the Git repository. Use the second Terminal window tab to run these bash commands.

    ````sh
    <copy>
    cd ~/cicd-ws-rep00
    git add v3.0/*
    git commit -a -m "Version 3: HR Events table and trigger"
    git push
    </copy>
    ````

14. On GitHub, click on **cicd-ws-rep00** link in the breadcrumbs at the top of the page. On the right side, under Releases, click Create a new release. Create a Release called '**Version 3 production**', use Tag version '**V3**'. Click **Publish release**.


## Task 5: Working on patch that changes columns in table

1. Once more, **Developer #1** from your team, pulls the updates from this Git repository on hers/his local development environment, working on the same project. For this lab, we will not pull the repository with `git pull cicd-ws-rep00`, but will work on the same folder, just to simplify the scenario, and avoid to create multiple copies of these files on the same compute node, as we have a single development environment.

2. In this section of the lab **Developer #1** is working on a ticket that has been raised for an issue. This patch can be developed on a separate Git branch. Run these bash commands in the second Terminal window tab to create a new branch called `ticket001`.

    ````sh
    <copy>
    git checkout -b ticket001

    git status
    </copy>
    ````

3. Exit SQLcl connection in the Terminal window first tab, and go to your project main folder.

    ````sh
    <copy>
    exit

    cd ~/cicd-ws-rep00
    </copy>
    ````

4. Create a new folder in your project main folder, for the first ticket of your project.

    ````sh
    <copy>
    mkdir v3.1

    cd v3.1
    </copy>
    ````

5. Connect as **HR** user to the ATP service.

    ````sh
    <copy>
    sql /nolog

    set cloudconfig /home/oracle/Downloads/Wallet_[Your Initials]Dev01.zip

    conn hr/DBlearnPTS#21_@[lowercase-initials]dev01_tp
    </copy>
    ````

6. Run these statements in SQLcl, as HR user, one by one.

    ````sql
    <copy>
    alter table PROSPECTS set unused (BIRTH_DATE);

    alter table PROSPECTS drop column PHONE_NUMBER;

    ALTER TABLE prospects ADD credit_limit NUMBER;
    </copy>
    ````

7. Generate a changelog for the new `PROSPECTS` table.

    ````sh
    <copy>
    lb genobject -type table -name prospects
    </copy>
    ````

8. Update master changelog `hr-master.xml` to include the patched `PROSPECTS` table, specifying this is the version 3.1 of the project. Add these lines after the last `</changeSet>` line, leaving the last line unchanged.

    ````xml
    ...
    <copy>
      <include file="./v3.1/prospects_table.xml" relativeToChangelogFile="true"/>
      <changeSet  author="Developer1"  id="tagDatabase-tk001">  
        <tagDatabase  tag="version_3.1"/>  
      </changeSet>
    </databaseChangeLog>
    </copy>
    ````

9. Every time you modify your master changelog, you must validate it.

    ````sh
    <copy>
    lb validate -changelog ./../hr-master.xml
    </copy>

    No issues were found in file ./../hr-master.xml, validation passed.
    ````

10. Mark all these initial changes as deployed in the local development database.

    ````sh
    <copy>
    lb changelogsync -changelog ./../hr-master.xml
    </copy>

    Operation completed successfully.
    ````

11. Use SQL Developer, connected as **HR** user to your ATP service to run the generated script from the previous step, and commit changes.

    ````sql
    <copy>
    /* changelogsync script here */

    commit;
    </copy>
    ````

12. Run this query ![](./images/run-query.jpg "") in SQL Developer to see changes currently recorded by Liquibase. `DATABASECHANGELOG` table tracks which changesets have been run in your database schema.

    ````sql
    <copy>
    select ID, AUTHOR, FILENAME, orderexecuted ORD, DESCRIPTION, TAG, EXECTYPE
      from DATABASECHANGELOG order by 4 desc;
    </copy>
    ````

13. Add initial schema changes to the Git repository. Use the second Terminal window tab to run these bash commands.

    ````sh
    <copy>
    cd ~/cicd-ws-rep00
    git add v3.1/*
    git commit -a -m "Version 3 ticket 001: Prospects drop 2 columns, add 1"
    git push --set-upstream origin ticket001
    </copy>
    ````

14. On GitHub, click on **cicd-ws-rep00** link in the breadcrumbs at the top of the page to refresh it. You will see this message: *ticket001 had recent pushes less than a minute ago*.

15. Click **Compare & pull request** > **Create pull request**. **Merge pull request** > **Confirm merge**.

16. When finished, you will receive this message: *Pull request successfully merged and closed*. Click **Delete branch**.
    - on GitHub click on cicd-ws-rep00 to refresh page
    - Compare & pull request > Create pull request. Merge pull request > Confirm merge. Delete branch.


## Task 6: Modify code and use Git to version changes

1. Again, **Developer #2** from your team, pulls the updates from this Git repository, to continue working on the same project. For this lab, we will not pull the repository with `git pull cicd-ws-rep00`, but will work on the same folder, just to simplify the scenario, and avoid to create multiple copies of these files on the same compute node, as we have a single development environment.

2. In this section of the lab **Developer #2** is working on a ticket that has been raised for bug in the code. This fix can be developed on a separate Git branch. Run these bash commands in the second Terminal window tab to create a new branch called `ticket002`.

    ````sh
    <copy>
    git checkout -b ticket002
    git status
    </copy>
    ````

3. Exit SQLcl connection in the Terminal window first tab, and go to your project main folder.

    ````sh
    <copy>
    exit

    cd ~/cicd-ws-rep00
    </copy>
    ````

4. Create a new folder in your project main folder, for the second ticket of your project.

    ````sh
    <copy>
    mkdir v3.2
    cd v3.2
    </copy>
    ````

5. Connect as **HR** user to the ATP service.

    ````sh
    <copy>
    sql /nolog

    set cloudconfig /home/oracle/Downloads/Wallet_[Your Initials]Dev01.zip

    conn hr/DBlearnPTS#21_@[lowercase-initials]dev01_tp
    </copy>
    ````

6. Use SQL Developer, connected as **HR** user to your ATP service to open `INVESTMENT_CHECK` Body under Packages, and change '`3*SAVINGS`' with '`2.5*SAVINGS`'.

7. Compile ![](./images/compile.jpg "") and close.

8. Use SQL Developer to open `BI_HR_EVENTS` trigger and add a second if condition:

    ````sql
    <copy>
    create or replace TRIGGER  "bi_HR_EVENTS"
      before insert on "HR_EVENTS"              
      for each row
    begin  
      if :new."ID" is null then
        select "HR_EVENTS_SEQ".nextval into :new."ID" from sys.dual;
      end if;
      if :new."REGION" is null then
        select 'GLOBAL' into :new."REGION" from sys.dual;
      end if;
    end;
    /
    </copy>
    ````

9. Compile ![](./images/compile.jpg "") and close.

10. Use SQLcl connection in the Terminal window first tab to generate changelogs for each one of the new objects individually (run these commands one by one).

    ````sh
    <copy>
    lb genobject -type PACKAGE_BODY -name investment_check

    lb genobject -type TRIGGER -name BI_HR_EVENTS
    </copy>
    ````

11. Update master changelog `hr-master.xml` to include the patched package and trigger, specifying this is the version 3.2 of the project. Add these lines after the last `</changeSet>` line, leaving the last line unchanged.

    ````xml
    ...
    <copy>
      <include file="./v3.2/investment_check_package_body.xml" relativeToChangelogFile="true"/>
      <include file="./v3.3/bi_hr_events_trigger.xml" relativeToChangelogFile="true"/>
      <changeSet  author="Developer2"  id="tagDatabase-tk002">  
        <tagDatabase  tag="version_3.2"/>  
      </changeSet>
    </databaseChangeLog>
    </copy>
    ````

12. Every time you modify your master changelog, you must validate it.

    ````sh
    <copy>
    lb validate -changelog ./../hr-master.xml
    </copy>

    No issues were found in file ./../hr-master.xml, validation passed.
    ````

13. Mark all these initial changes as deployed in the local development database.

    ````sh
    <copy>
    lb changelogsync -changelog ./../hr-master.xml
    </copy>

    Operation completed successfully.
    ````

14. Use SQL Developer, connected as **HR** user to your ATP service to run the generated script from the previous step, and commit changes.

    ````sql
    <copy>
    /* changelogsync script here */

    commit;
    </copy>
    ````

15. Run this query ![](./images/run-query.jpg "") in SQL Developer to see changes currently recorded by Liquibase. `DATABASECHANGELOG` table tracks which changesets have been run in your database schema.

    ````sql
    <copy>
    select ID, AUTHOR, FILENAME, orderexecuted ORD, DESCRIPTION, TAG, EXECTYPE
      from DATABASECHANGELOG order by 4 desc;
    </copy>
    ````

16. Add initial schema changes to the Git repository. Use the second Terminal window tab to run these bash commands.

    ````sh
    <copy>
    cd ~/cicd-ws-rep00
    git add v3.2/*
    git commit -a -m "Version 3 ticket 002: Code changes in package body and trigger"
    git push --set-upstream origin ticket002
    </copy>
    ````
17. On GitHub, click on **cicd-ws-rep00** link in the breadcrumbs at the top of the page to refresh it. You will see this message: *ticket002 had recent pushes less than a minute ago*.

18. Click **Compare & pull request**. Review all code changes detailed on the lower part of the page. Click **Create pull request**. **Merge pull request** > **Confirm merge**.

19. When finished, you will receive this message: *Pull request successfully merged and closed*. Click **Delete branch**.

20. Click again on **cicd-ws-rep00** link in the breadcrumbs. Click **Releases** on the right side of the page, then click **Draft a new release**. Name it '**Release Version 3.2 production**', use Tag version '**V3.2**'. Click **Publish release**.

21. Click again Releases. Under **V3.2** click **Compare**, select **V3**. Review Comparing changes.


## Task 7: Provision another Development Database (ATP)

1. This is **Developer #3** from your team, that has to work on a new project, using a new database **ATPdev02**. For this lab, we will not clone the repository with `git clone cicd-ws-rep00`, but will work on the same folder, just to simplify the scenario, and avoid to create multiple copies of these files on the same compute node, as we have a single development environment.

2. On Oracle Cloud Console, click on main menu ≡, then **Autonomous Transaction Processing** under Oracle Database. **Create Autonomous Database**.
    - Select a compartment: [Your Compartment]
    - Display name: [Your Initials]Dev02 (e.g. VLTDev02)
    - Database name: [Your Initials]Dev02 (e.g. VLTDev02)
    - Choose a workload type: Transaction Processing
    - Choose a deployment type: Shared Infrastructure
    - Choose database version: 19c
    - OCPU count: 1
    - Storage (TB): 1
    - Auto scaling: disabled

3. Under Create administrator credentials:
    - Password: DBlearnPTS#21_

4. Under Choose network access:
    - Access Type: Allow secure access from everywhere

5. Click **Create Autonomous Database**. Wait for Lifecycle State to become Available.

6. Download and unzip the client credentials `Wallet_[Your Initials]Dev02.zip` file, selecting instance wallet file, on the ClientVM. If you use the Firefox browser on the Remote Desktop connection, it will be downloaded in folder `/home/oracle/Downloads/`.

7. Specify a wallet password.
    - Password: DBlearnPTS#21_

8. Set the location of your wallet file for your **Dev02** ATP service.

    ````sql
    <copy>
    sql /nolog

    set cloudconfig /home/oracle/Downloads/Wallet_[Your Initials]Dev02.zip
    </copy>
    ````

9. Connect to your **Dev02** ATP service as **admin** user.

    ````sql
    <copy>
    conn admin/DBlearnPTS#21_@[lowercase-initials]dev02_high
    </copy>
    ````

10. Create an empty HR schema for the new project in **ATPdev02** development environment.

    ````sql
    <copy>
    CREATE USER HR IDENTIFIED BY DBlearnPTS#21_;
    GRANT connect, resource to HR;
    GRANT UNLIMITED TABLESPACE TO HR;
    GRANT create view to HR;
    </copy>
    ````

11. Connect to the **ATPdev02** ATP service as **HR** user.

    ````sql
    <copy>
    conn hr/DBlearnPTS#21_@[lowercase-initials]dev02_high
    </copy>
    ````

12. Verify **HR** user tables. This schema has no objects.

    ````sql
    <copy>
    tables
    </copy>

    no rows selected
    ````

13. Generate and render to the screen the SQL statements that would be applied for `hr-master.xml` master changelog.

    ````sql
    <copy>
    lb updatesql -changelog hr-master.xml
    </copy>

    Errors encountered:0
    ````

14. Verify again **HR** user tables. This schema has one table with Liquibase actions.

    ````sql
    <copy>
    tables
    </copy>
                          TABLES
    ____________________________
    DATABASECHANGELOG_ACTIONS    
    ````

15. Apply all HR schema objects and code specified in master changelog to this new database environment.

    ````sql
    <copy>
    lb update -changelog hr-master.xml
    </copy>

    Errors encountered:0
    ````

16. Verify again **HR** user tables. This time we have all tables created.

    ````sql
    <copy>
    tables
    </copy>
                          TABLES
    ____________________________
    DATABASECHANGELOG_ACTIONS    
    DATABASECHANGELOGLOCK        
    DATABASECHANGELOG            
    COUNTRIES                    
    EMPLOYEES                    
    JOB_HISTORY                  
    DEPARTMENTS                  
    JOBS                         
    REGIONS                      
    LOCATIONS                    
    PROSPECTS                    
    HR_EVENTS                    

    12 rows selected.
    ````

17. However, all application tables are empty, data has to be migrated separately.

    ````sql
    <copy>
    select * from PROSPECTS;
    </copy>

    no rows selected
    ````

18. Compare **HR** schema objects in **ATPdev01** and **ATPdev02** ATP services.

    ````sql
    <copy>
    select object_type, count(*) from user_objects
    group by object_type order by 1;
    </copy>

        OBJECT_TYPE    COUNT(*)
    _______________ ___________
    INDEX                    25
    LOB                       3
    PACKAGE                   1
    PACKAGE BODY              1
    PROCEDURE                 2
    SEQUENCE                  4
    TABLE                    12
    TRIGGER                   4
    VIEW                      1

    9 rows selected.
    ````

    ````sql
    <copy>
    set cloudconfig /home/oracle/Downloads/Wallet_[Your Initials]Dev01.zip

    conn hr/DBlearnPTS#21_@[lowercase-initials]dev01_high
    </copy>
    ````

    ````sql
    <copy>
    select object_type, count(*) from user_objects
    group by object_type order by 1;
    </copy>

        OBJECT_TYPE    COUNT(*)
    _______________ ___________
    INDEX                    25
    LOB                       8
    PACKAGE                   1
    PACKAGE BODY              1
    PROCEDURE                 2
    SEQUENCE                  4
    TABLE                    12
    TRIGGER                   4
    VIEW                      1

    9 rows selected.
    ````

    ````
    <copy>
    tables
    </copy>
                          TABLES
    ____________________________
    REGIONS                      
    COUNTRIES                    
    LOCATIONS                    
    DEPARTMENTS                  
    JOBS                         
    EMPLOYEES                    
    JOB_HISTORY                  
    DATABASECHANGELOG_ACTIONS    
    DATABASECHANGELOGLOCK        
    DATABASECHANGELOG            
    PROSPECTS                    
    HR_EVENTS                    

    12 rows selected.
    ````

19. Application tables in **ATPdev01** ATP services have the original data.

    ````sql
    <copy>
    select * from PROSPECTS;
    </copy>

    107 rows selected.
    ````

20. Clean up OCI environment by terminating all resources:
    * ATPdev01 database **[Your Initials]Dev01**
    * ATPdev02 database **[Your Initials]Dev02**
    * Compute instance **[Your Initials]-ClientVM**
    * VCN **[Your Initials]-VCN**

    You may now **proceed to the next lab**.

## Acknowledgements
* **Author** - Valentin Leonard Tabacaru
* **Last Updated By/Date** -  Valentin Leonard Tabacaru, March 2023
